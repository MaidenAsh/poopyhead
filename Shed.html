<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shed</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-image: url(images/bg2.jpg);
        }
        #shedCanvas {
            border: 3px solid black;
            border-radius: 15px;
            background-image: url(images/bg.jpg);
            background-size: 800px 800px;
        }
    </style>
</head> 
<body onload="initGame()">                 
    <canvas id="shedCanvas" width="800" height="800"></canvas>
    <!--Every card image is inside this div element-->
    <div style="display:none;">
        <img id="spades2" src="images/spades2.png";/>
        <img id="spades3" src="images/spades3.png";/>
        <img id="spades4" src="images/spades4.png";/>
        <img id="spades5" src="images/spades5.png";/>
        <img id="spades6" src="images/spades6.png";/>
        <img id="spades7" src="images/spades7.png";/>
        <img id="spades8" src="images/spades8.png";/>
        <img id="spades9" src="images/spades9.png";/>
        <img id="spades10" src="images/spades10.png";/>
        <img id="spadesJ" src="images/spadesJ.png";/>
        <img id="spadesQ" src="images/spadesQ.png";/>
        <img id="spadesK" src="images/spadesK.png";/>
        <img id="spadesA" src="images/spadesA.png";/>
        
        <img id="clubs2" src="images/clubs2.png";/>
        <img id="clubs3" src="images/clubs3.png";/>
        <img id="clubs4" src="images/clubs4.png";/>
        <img id="clubs5" src="images/clubs5.png";/>
        <img id="clubs6" src="images/clubs6.png";/>
        <img id="clubs7" src="images/clubs7.png";/>
        <img id="clubs8" src="images/clubs8.png";/>
        <img id="clubs9" src="images/clubs9.png";/>
        <img id="clubs10" src="images/clubs10.png";/>
        <img id="clubsJ" src="images/clubsJ.png";/>
        <img id="clubsQ" src="images/clubsQ.png";/>
        <img id="clubsK" src="images/clubsK.png";/>
        <img id="clubsA" src="images/clubsA.png";/>

        <img id="diamonds2" src="images/diamonds2.png";/>
        <img id="diamonds3" src="images/diamonds3.png";/>
        <img id="diamonds4" src="images/diamonds4.png";/>
        <img id="diamonds5" src="images/diamonds5.png";/>
        <img id="diamonds6" src="images/diamonds6.png";/>
        <img id="diamonds7" src="images/diamonds7.png";/>
        <img id="diamonds8" src="images/diamonds8.png";/>
        <img id="diamonds9" src="images/diamonds9.png";/>
        <img id="diamonds10" src="images/diamonds10.png";/>
        <img id="diamondsJ" src="images/diamondsJ.png";/>
        <img id="diamondsQ" src="images/diamondsQ.png";/>
        <img id="diamondsK" src="images/diamondsK.png";/>
        <img id="diamondsA" src="images/diamondsA.png";/>

        <img id="hearts2" src="images/hearts2.png";/>
        <img id="hearts3" src="images/hearts3.png";/>
        <img id="hearts4" src="images/hearts4.png";/>
        <img id="hearts5" src="images/hearts5.png";/>
        <img id="hearts6" src="images/hearts6.png";/>
        <img id="hearts7" src="images/hearts7.png";/>
        <img id="hearts8" src="images/hearts8.png";/>
        <img id="hearts9" src="images/hearts9.png";/>
        <img id="hearts10" src="images/hearts10.png";/>
        <img id="heartsJ" src="images/heartsJ.png";/>
        <img id="heartsQ" src="images/heartsQ.png";/>
        <img id="heartsK" src="images/heartsK.png";/>
        <img id="heartsA" src="images/heartsA.png";/>

        <img id="redJoker" src="images/redJoker.png";/>
        <img id="blackJoker" src="images/blackJoker.png";/>

        <img id="redBack" src="images/Back Red.png";/>
        <img id="blueBack" src="images/Back Blue.png";/>

        <img id="speakerOff" src="images/speakerOff.png"/>
        <img id="speakerOn" src="images/speakerOn.png"/>

        <audio id="placeCard"><source src="audio/placeCard.mp3" type="audio/mpeg"></audio>
        <audio id="bgMusic"><source src ="audio/Jazz BGM.mp3" ></audio>
        <audio id="burnSFX"><source src="audio/burnStack.mp3"></audio>                  
        <audio id="forfeitSFX"><source src="audio/forfeit.mp3"></audio>
        <audio id="victory"><source src="audio/victory.mp3"></audio>
        <audio id="defeat"><source src="audio/defeat.mp3"></audio> 
    </div>      
    <script>                                
        const canvas = document.getElementById('shedCanvas');
        const ctx = canvas.getContext('2d');
        
        var suits = ["spades", "diamonds", "clubs", "hearts"];
        var values = ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"]; 
        let gameRunning;
        let swapping;
        let p1 = false;
        let p2 = false;
        // -able variables to enable buttons
        let swappable = false;  
        let readyable = true;
        let playable = false;
        let forfeitable = false;
        let replayable = false;
        let showInfo = false;
        let bgm = document.getElementById("bgMusic");
        // Arrays for the places the cards can be
        let deck = []; 
        let downcard1 = [];
        let downcard2 = []; 
        let upcard1 = [];
        let upcard2 = [];
        let handcard1 = [];
        let handcard2 = [];
        let selected = []; // List of selected cards
        let stack = []; // Stack of cards in center
        let msg1 = "";  
        let msg2 = "";

        // Adjusting volume and speed of sound effects     
        document.getElementById("bgMusic").volume = 0.15;
        document.getElementById("bgMusic").loop = true;      
        document.getElementById("placeCard").playbackRate = 3.0;
        document.getElementById("burnSFX").playbackRate = 1.25;
        document.getElementById("forfeitSFX").playbackRate = 2.0;    
        document.getElementById("forfeitSFX").volume = 0.75;

        canvas.addEventListener("click",selectCards);       

        function initGame() {                                            
            gameRunning = true;                 
            swapping = true;
            p1 = true;
            createDeck(deck);
            values.push("Joker"); // Facilitates sorting cards in hand
            deal();                   
            draw();         
            sortHand();                                                 
            renderCards();  
        }                                                                              

        function createDeck(deck) {
            // Iterates through suits and values to create cards
            for (let i = 0; i<suits.length; i++) {
                for (let j = 0; j<values.length; j++) {
                    deck.push({Value: values[j], Suit: suits[i], Magical: false, x1: 0, x2: 0, y1: 0, y2: 0, Selected: false})
                }
            }           
            // Defines magical cards
            for (let i = 0; i<deck.length; i++) {
                switch(deck[i].Value) {
                    case "2":
                    case "7":
                    case "8":
                    case "10":
                        deck[i].Magical = true
                        break;
                }
            }
            // Adds Jokers
            deck.push({Value: "Joker", Suit: "red", Magical: true, x1: 0, x2: 0, y1: 0, y2: 0, Selected: false})
            deck.push({Value: "Joker", Suit: "black", Magical: true, x1: 0, x2: 0, y1: 0, y2: 0, Selected: false})
            // Shuffles       
            for (let i = 0; i<1000; i++) {
                let positionA = Math.floor(Math.random()*deck.length)
                let positionB = Math.floor(Math.random()*deck.length)
                let mid = deck[positionA]
                        
                deck[positionA] = deck[positionB]
                deck[positionB] = mid
            }
        }   

        function deal() {
            // Deals 3 downcards and 3 upcards to each player
            while (downcard1.length<3) {
                downcard1.push(deck.pop())
            }
            while (downcard2.length<3) {
                downcard2.push(deck.pop())
            }
            while (upcard1.length<3) {
                upcard1.push(deck.pop())
            }   
            while (upcard2.length<3) {
                upcard2.push(deck.pop())
            }
        }

        function draw() {
            // Draws until 3 cards in hand, as long as there's cards left in the deck
            while (handcard1.length<3 && deck.length != 0) {
                handcard1.push(deck.pop())
            }                                   
            while (handcard2.length<3 && deck.length != 0) {
                handcard2.push(deck.pop())
            }
        }       

        function formString(card) {
            // Uses a card's suit and value to form a string to facilitate calling an image via ID
            let string = ''
            return string += card.Suit + card.Value
        }
                
        function renderCards() {
            // Draws the cards and buttons onto the canvas
            // Player's downcards
            for (let i = 0; i<downcard1.length; i++) {
                let x = i*120 + 240
                downcard1[i].x1 = x
                downcard1[i].x2 = x + 80
                downcard1[i].y1 = 510
                downcard1[i].y2 = 630
                ctx.drawImage(document.getElementById("redBack"), x, 510, 80, 120)
                if (downcard1[i].Selected == true) {
                    ctx.lineWidth = "5"
                    ctx.lineJoin = "round"
                    ctx.strokeStyle = "gold"
                    ctx.strokeRect(downcard1[i].x1+2, downcard1[i].y1+2, 76, 115)
                }
            }     
            // Bot's downcards
            for (let i = 0; i<downcard2.length; i++) {
                let x = i*120 + 240
                ctx.drawImage(document.getElementById("blueBack"), x, 170, 80, 120)
            }       
            // Player's upcards
            for (let i = 0; i<upcard1.length; i++) {
                let s = formString(upcard1[i])
                let x = i*120 + 240
                upcard1[i].x1 = x
                upcard1[i].x2 = x + 80
                upcard1[i].y1 = 505
                upcard1[i].y2 = 625
                ctx.drawImage(document.getElementById(s), x, 505, 80, 120)
                if (upcard1[i].Selected == true) {
                    ctx.lineWidth = "5"
                    ctx.lineJoin = "round"
                    ctx.strokeStyle = "gold"
                    ctx.strokeRect(upcard1[i].x1+2, upcard1[i].y1+2, 76, 115)
                }
            }    
            // Bot's upcards
            for (let i = 0; i<upcard2.length; i++) {
                let s = formString(upcard2[i])
                let x = i*120 + 240
                ctx.drawImage(document.getElementById(s), x, 165, 80, 120)
            }           
            // Player's handcards
            for (let i = 0; i<handcard1.length; i++) {
                let s = formString(handcard1[i])
                let gap = ((400-(80*handcard1.length))/(handcard1.length + 1))
                let interval = 80 + gap
                let initial = 200 + gap
                let x = i*interval + initial
                handcard1[i].x1 = x
                handcard1[i].x2 = x + 80
                if (i > 0) {
                    // Adjusts previous card's x2 co-ord if there's overlap
                    if (handcard1[i-1].x2 > x) {
                        handcard1[i-1].x2 = x-3
                    }
                } 
                handcard1[i].y1 = 680
                handcard1[i].y2 = 800
                ctx.drawImage(document.getElementById(s), x, 680, 80, 120)
                if (handcard1[i].Selected == true) {
                    ctx.lineWidth = "5"
                    ctx.lineJoin = "round"
                    ctx.strokeStyle = "gold"
                    ctx.strokeRect(handcard1[i].x1+2, handcard1[i].y1+2, 76, 115)
                }
            }           
            // Bot's handcards
            for (let i = 0; i<handcard2.length; i++) { 
                let gap = ((400-(80*handcard2.length))/(handcard2.length + 1))  
                let interval = 80 + gap
                let initial = 200 + gap     
                let x = i*interval + initial    
                //let s = formString(handcard2[i])
                ctx.drawImage(document.getElementById("blueBack"), x, 0, 80, 120)
            }   
            // Deck
            for (let i = 0; i<deck.length; i++) {
                let y = 340 - i*0.75;                                                            
                ctx.drawImage(document.getElementById("redBack"), 300, y, 80, 120);
            }
            // Stack
            for (let i = 0; i<stack.length; i++) { 
                let s = formString(stack[i])
                let y = 340 - i*0.75;
                ctx.drawImage(document.getElementById(s), 420, y, 80, 120);
            }
            // Ready button
            if (gameRunning == true && swapping == true) {
                readyable = true
                drawReadyButton()
            } else {
                readyable = false
            }
            // Swap button
            if (gameRunning == true && swapping == true && selected.length == 2) {
                swappable = true
                drawSwapButton()
            } else {
                swappable = false
            }
            // Play button
            if (gameRunning == true && swapping == false && selected.length>0) {
                playable = true
                drawPlayButton()
            }   else {
                playable = false
            }
            // Forfeit button
            if (gameRunning == true && swapping == false && stack.length>0) {
                forfeitable = true
                drawForfeitButton()
            }   else {
                forfeitable = false
            }
            // Info screen + button
            if (showInfo == true) {
                //const infoTO = setTimeout(drawInfo,100)
                drawInfo()
            } else if (showInfo == false) {
                //const infoButtonTO = setTimeout(drawInfoButton,300)   
                drawInfoButton()
            }   

            drawSpeaker()
        }           

        function selectCards() {  
            // Handles all clicking, key function for the game loop
            bgm.play()
            if (gameRunning == true) {
                // Initial swap phase
                if (swapping == true && selected.length<=2) {
                    for (let i = 0; i<upcard1.length; i++) {
                        // Only selects if no other upcards have been selected
                        if (event.offsetX > upcard1[i].x1 && event.offsetX < upcard1[i].x2
                            && event.offsetY > upcard1[i].y1 && event.offsetY < upcard1[i].y2) {
                                if (upcard1[i].Selected == false &&     
                                upcard1.filter((card) => card.Selected == true).length == 0) {
                                    upcard1[i].Selected = true
                                    selected.push(upcard1[i])
                                } else if (upcard1[i].Selected == true) {
                                    selected = selected.filter((card) => card != upcard1[i])
                                    upcard1[i].Selected = false
                                }   
                        } 
                    }   
                    for (let i = 0; i<handcard1.length; i++) {
                        // Only selects if no other handcards have been selected
                        if (event.offsetX > handcard1[i].x1 && event.offsetX < handcard1[i].x2
                            && event.offsetY > handcard1[i].y1 && event.offsetY < handcard1[i].y2) {
                                if (handcard1[i].Selected == false && 
                                handcard1.filter((card) => card.Selected == true).length == 0) {
                                    handcard1[i].Selected = true
                                    selected.push(handcard1[i]) 
                                } else if (handcard1[i].Selected == true) {
                                    selected = selected.filter((card) => card != handcard1[i])
                                    handcard1[i].Selected = false
                                }
                        } 
                    }   
                    // Swap button
                    if (swappable == true && showInfo == false) {
                        if (event.offsetX > 60 && event.offsetX < 180
                        && event.offsetY > 530 && event.offsetY < 610) {
                            swapCards()
                        }
                    }
                    // Ready button
                    if (readyable == true && showInfo == false) {
                        if (event.offsetX > 620 && event.offsetX < 740
                        && event.offsetY > 530 && event.offsetY < 610) {
                            for (let i = 0; i<upcard1.length;i++) {
                                upcard1[i].Selected = false
                            }
                            for (let i = 0; i<handcard1.length;i++) {
                                handcard1[i].Selected = false
                            }
                            cleanse()
                            swapping = false
                        }   
                    }
                    // Info button
                    if (showInfo == false) {
                        if (event.offsetX > 45 && event.offsetX < 95
                        && event.offsetY > 35 && event.offsetY < 85) {
                            showInfo = true
                        }       
                    } else if (showInfo == true) {
                        if (event.offsetX > 685 && event.offsetX < 725
                        && event.offsetY > 70 && event.offsetY < 110) {
                            showInfo = false
                        }   
                    }
                    // Background music
                    if (bgm.muted == true) {
                        if (event.offsetX > 705 && event.offsetX < 775
                        && event.offsetY > 24 && event.offsetY < 94) {
                            bgm.muted = false
                        }       
                    } else if (bgm.muted == false) {
                        if (event.offsetX > 705 && event.offsetX < 775
                        && event.offsetY > 24 && event.offsetY < 94) {
                            bgm.muted = true
                        }   
                    }
                    routine()   
                }           
                // Main game phase
                if (swapping == false && p1 == true) {
                    // When handcards are present
                    if (handcard1.length>0) {
                        for (let i = 0; i<handcard1.length; i++) {
                            if (event.offsetX > handcard1[i].x1 && event.offsetX < handcard1[i].x2
                                && event.offsetY > handcard1[i].y1 && event.offsetY < handcard1[i].y2) {
                                    if (handcard1[i].Selected == false) {    
                                        if (selected.length>0) {
                                            if (handcard1[i].Value == selected[0].Value) {
                                                handcard1[i].Selected = true
                                                selected.push(handcard1[i])
                                            }   
                                        }
                                        if (selected.length == 0) {
                                            handcard1[i].Selected = true
                                            selected.push(handcard1[i])
                                        }
                                    } else if (handcard1[i].Selected == true) {
                                        selected = selected.filter((card) => card != handcard1[i])
                                        handcard1[i].Selected = false
                                    }
                            } 
                        }     
                    }
                    // When the player is playing from upcards
                    if (handcard1.length == 0 && upcard1.length>0) {
                        for (let i = 0; i<upcard1.length; i++) {
                            if (event.offsetX > upcard1[i].x1 && event.offsetX < upcard1[i].x2
                                && event.offsetY > upcard1[i].y1 && event.offsetY < upcard1[i].y2) {
                                    if (upcard1[i].Selected == false) {    
                                        if (selected.length>0) {
                                            if (upcard1[i].Value == selected[0].Value) {
                                                upcard1[i].Selected = true
                                                selected.push(upcard1[i])
                                            }
                                        }
                                        if (selected.length == 0) {
                                            upcard1[i].Selected = true
                                            selected.push(upcard1[i])
                                        }
                                    } else if (upcard1[i].Selected == true) {
                                        selected = selected.filter((card) => card != upcard1[i])
                                        upcard1[i].Selected = false
                                    }
                            } 
                        }   
                    }   
                    // When the player is using downcards
                    if (handcard1.length == 0 && upcard1.length == 0 && downcard1.length>0) {
                        for (let i = 0; i<downcard1.length; i++) {
                            if (event.offsetX > downcard1[i].x1 && event.offsetX < downcard1[i].x2
                                && event.offsetY > downcard1[i].y1 && event.offsetY < downcard1[i].y2) {
                                    if (downcard1[i].Selected == false) {
                                        if (selected.length == 0) {
                                            downcard1[i].Selected = true
                                            selected.push(downcard1[i])
                                        }
                                    } else if (downcard1[i].Selected == true) {
                                        selected = selected.filter((card) => card != downcard1[i])
                                        downcard1[i].Selected = false
                                    }
                            } 
                        }   
                    }
                    // Play button
                    if (playable == true && showInfo == false) {
                        if (event.offsetX > 620 && event.offsetX < 740
                        && event.offsetY > 530 && event.offsetY < 610) {
                            playCards(1)
                            const burnTO = setTimeout(checkBurn,900,1)
                        }   
                    }
                    // Forfeit button
                    if (forfeitable == true && showInfo == false) {
                        if (event.offsetX > 60 && event.offsetX < 180
                        && event.offsetY > 530 && event.offsetY < 610) {
                            forfeit(1)
                        }
                    }
                    // Info button
                    if (showInfo == false) {
                        if (event.offsetX > 45 && event.offsetX < 95
                        && event.offsetY > 35 && event.offsetY < 85) {
                            showInfo = true
                        }       
                    } else if (showInfo == true) {
                        if (event.offsetX > 685 && event.offsetX < 725
                        && event.offsetY > 70 && event.offsetY < 110) {
                            showInfo = false
                        }   
                    }  
                    // Background music
                    if (bgm.muted == true) {
                        if (event.offsetX > 705 && event.offsetX < 775
                        && event.offsetY > 24 && event.offsetY < 94) {
                            bgm.muted = false
                        }       
                    } else if (bgm.muted == false) {
                        if (event.offsetX > 705 && event.offsetX < 775
                        && event.offsetY > 24 && event.offsetY < 94) {
                            bgm.muted = true
                        }   
                    }
                    routine()
                    if (p2 == true || downcard1.length == 0) {
                        const vicTO = setTimeout(checkVictory, 1000) // checkVictory also contains the cue for the bot to move  
                    }
                }   
            } else if (gameRunning == false) {
                // After the player wins or loses
                if (replayable == true) {
                    if (event.offsetX > 340 && event.offsetX < 460
                    && event.offsetY > 420 && event.offsetY < 500) {
                        location.reload() // Reloads the document
                    }
                }   
            }
        }                   

        function sortHand() {
            // Sorts hands via values array
            handcard1.sort((a,b) => values.findIndex((x) => x == a.Value) - values.findIndex((x) => x == b.Value))
            handcard2.sort((a,b) => values.findIndex((x) => x == a.Value) - values.findIndex((x) => x == b.Value))
        }
        
        function clear() {
            // Clears canvas before rendering
            ctx.clearRect(0,0,800,800)
        }

        function swapCards() {
            // Swaps between handcards and upcards during swap phase
            if (selected.length == 2) {
                let hand = selected.filter((x) => handcard1.includes(x)).pop()
                let up = selected.filter((x) => upcard1.includes(x)).pop()
                cleanse()
                hand.Selected = false   
                up.Selected = false
                handcard1.push(up)
                upcard1.push(hand)
                document.getElementById("placeCard").play()
            }       
        }

        function cleanse() {
            // Removes selected cards from player's cards and empties 'selected' array
            handcard1 = handcard1.filter((card) => card.Selected != true)
            upcard1 = upcard1.filter((card) => card.Selected != true)
            downcard1 = downcard1.filter((card) => card.Selected != true)
            handcard2 = handcard2.filter((card) => card.Selected != true)
            upcard2 = upcard2.filter((card) => card.Selected != true)
            downcard2 = downcard2.filter((card) => card.Selected != true)
            selected = []
        }

        function drawSwapButton() {
            // Renders on left side
            ctx.fillStyle = "#ff2b2b"
            ctx.roundRect(60, 530, 120, 80, 5)                                               
            ctx.fill()
            ctx.strokeStyle = "black"
            ctx.lineWidth = 5
            ctx.lineJoin = "round"
            ctx.strokeRect(60, 530, 120, 80)
            ctx.beginPath();
            ctx.moveTo(60,570);
            ctx.lineTo(180,570);
            ctx.closePath();
            ctx.textBaseline = "middle"
            ctx.beginPath();
            ctx.moveTo(120,530);
            ctx.lineTo(120,610);
            ctx.closePath();
            ctx.textAlign = "center"
            ctx.fillStyle ="black"
            ctx.font = "bold 30px Times New Roman"
            ctx.fillText("Swap", 120, 570)    
        }

        function drawReadyButton() {
            // Renders on right side    
            ctx.fillStyle = "#ff2b2b"
            ctx.roundRect(620, 530, 120, 80, 5)                                               
            ctx.fill()
            ctx.strokeStyle = "black"
            ctx.lineWidth = 5
            ctx.lineJoin = "round"
            ctx.strokeRect(620, 530, 120, 80)
            ctx.beginPath();
            ctx.moveTo(620,570);
            ctx.lineTo(740,570);
            ctx.closePath();
            ctx.textBaseline = "middle"
            ctx.beginPath();
            ctx.moveTo(680,530);
            ctx.lineTo(680,610);
            ctx.closePath();
            ctx.textAlign = "center"
            ctx.fillStyle ="black"  
            ctx.font = "bold 30px Times New Roman"
            ctx.fillText("Ready", 680, 570)
        }

        function drawPlayButton() {
            // Renders on right side
            ctx.fillStyle = "#ff2b2b"
            ctx.roundRect(620, 530, 120, 80, 5)                                               
            ctx.fill()
            ctx.strokeStyle = "black"
            ctx.lineWidth = 5
            ctx.lineJoin = "round"
            ctx.strokeRect(620, 530, 120, 80)
            ctx.beginPath();
            ctx.moveTo(620,570);
            ctx.lineTo(740,570);
            ctx.closePath();
            ctx.textBaseline = "middle"
            ctx.beginPath();
            ctx.moveTo(680,530);
            ctx.lineTo(680,610);
            ctx.closePath();
            ctx.textAlign = "center"
            ctx.fillStyle ="black"  
            ctx.font = "bold 30px Times New Roman"
            ctx.fillText("Play", 680, 570)
        }

        function drawForfeitButton() {
            // Renders on left side
            ctx.fillStyle = "#ff2b2b"
            ctx.roundRect(60, 530, 120, 80, 5)                                               
            ctx.fill()
            ctx.strokeStyle = "black"
            ctx.lineWidth = 5
            ctx.lineJoin = "round"
            ctx.strokeRect(60, 530, 120, 80)
            ctx.beginPath();
            ctx.moveTo(60,570);
            ctx.lineTo(180,570);
            ctx.closePath();
            ctx.textBaseline = "middle"
            ctx.beginPath();
            ctx.moveTo(120,530);
            ctx.lineTo(120,610);
            ctx.closePath();
            ctx.textAlign = "center"
            ctx.fillStyle ="black"
            ctx.font = "bold 30px Times New Roman"
            ctx.fillText("Forfeit", 120, 570)    
        }

        function drawReplayButton() {
            ctx.fillStyle = "#ff2b2b"
            ctx.roundRect(340, 420, 120, 80, 5)                                               
            ctx.fill()

            ctx.strokeStyle = "black"
            ctx.lineWidth = 5
            ctx.lineJoin = "round"
            ctx.strokeRect(340, 420, 120, 80)

            ctx.beginPath();
            ctx.moveTo(400,420);
            ctx.lineTo(400,500);
            ctx.closePath();
            ctx.textAlign = "center"

            ctx.beginPath();
            ctx.moveTo(340,460);
            ctx.lineTo(460,460);
            ctx.closePath();
            ctx.textBaseline = "bottom"

            ctx.fillStyle ="black"  
            ctx.font = "bold 30px Times New Roman"
            ctx.fillText("Play", 400, 460)

            ctx.textBaseline = "top"
            ctx.fillText("Again?", 400, 460)
        }

        function transferToStack(x) {
            // Transfers selected cards to stack
            for (let i = 0; i<selected.length;i++) {
                let mid = selected[i]
                stack.push(mid)
            }   
            document.getElementById("placeCard").play()
            // Creates message to display when cards are played
            let msgString = ""
            switch(selected.length) {
                case 1:
                    msgString += "played one " + (selected[0].Value).toString() + "."
                    break;
                case 2:
                    msgString += "played two " + (selected[0].Value).toString() + "s."
                    break;
                case 3:
                    msgString += "played three " + (selected[0].Value).toString() + "s."
                    break;
                case 4:
                    msgString += "played four " + (selected[0].Value).toString() + "s."
                    break;
            }
            if (x == 1) {
                msg1 = msgString
            } else if (x == 2) {
                msg2 = msgString
            }
            cleanse()        
        }                                  

        function compareCards(a,b) {
            // Compares the selected card(s), a, with the card in the stack, b
            if (b.Value == "Joker") {
                if (a.Magical == true && a.Value != "Joker") {
                    return false    
                } else if (a.Magical == false || a.Value == "Joker") {
                    if (stack.findLastIndex((x) => x.Value != "Joker") != -1) {
                        return compareCards(a,stack.at(stack.findLastIndex((x) => x.Value != "Joker")))
                    } else if (stack.findLastIndex((x) => x.Value != "Joker") == -1) {
                        return true 
                    }
                }                       
            } else if (b.Value == "8") {
                let index = stack.findLastIndex((x) => x.Value != "8" && x.Value != "Joker")
                if (index != -1) {      
                    return compareCards(a,stack.at(index))
                } else if (index == -1) {
                    return true 
                }               
            } else if (b.Value == "7") {                
                if (a.Magical == true || a.Value < 7) {
                    return true
                } else {
                    return false
                }               
            } else {
                if (a.Magical == true ||
                values.findIndex((x) => x == a.Value) - values.findIndex((x) => x == b.Value) >= 0) {
                    return true
                } else {
                    return false
                }
            }
        }           
            
        function playCards(x) {
            // Determines whether the cards selected are valid to play and forfeits if not
            if (stack.length > 0) {
                if (compareCards(selected[0],stack.at(-1))) {
                    transferToStack(x)
                    changeTurn()    
                } else {
                    transferToStack(x)
                    forfeit(x) // Turn changing included in forfeit
                }
            } else {
                transferToStack(x)
                changeTurn()    
            }
        }

        function forfeit(x) {
            // Transfers cards from stack to hand
            if (x == 1) {
                handcard1 = handcard1.concat(stack)
                stack = []
                msg1 = "picked up the stack!"
                for (let i = 0; i<handcard1.length;i++) {
                    handcard1[i].Selected = false
                }
            } else if (x == 2) {
                handcard2 = handcard2.concat(stack)
                stack = []
                msg2 = "picked up the stack!"
                for (let i = 0; i<handcard2.length;i++) {
                    handcard2[i].Selected = false
                }
            }   
            changeTurn()
            routine();
            document.getElementById("forfeitSFX").play()
        }                   

        function burn(x) {      
            // Burns the stack and displays relevant message
            stack = []
            if (x == 1) {
                msg1 = "burned the stack!"
            } else if (x == 2) {
                msg2 = "burned the stack!"
                const myTimeout = setTimeout(botMove,1000)
                const burnTO = setTimeout(checkBurn,2000,2)
            }
            document.getElementById("burnSFX").play()
            changeTurn() // Cancels out the turn change inside playCards
        }                                       
                                        
        function checkVictory() {
            // Checks if the player won
            if (downcard1.length == 0 && upcard1.length == 0 && handcard1.length == 0) {
                p1 = false
                p2 = false
                gameRunning = false
                replayable = true
                clear() 
                msg1 = ""            
                msg2 = ""
                ctx.font = "bold italics 100px Times New Roman"
                ctx.fillText("You Win!", 400, 370)
                drawReplayButton()
                document.getElementById("bgMusic").load()
                document.getElementById("victory").play()
            }
            // Checks if the bot won
            if (downcard2.length == 0 && upcard2.length == 0 && handcard2.length == 0) {
                p1 = false
                p2 = false
                gameRunning = false
                replayable = true
                clear()     
                msg1 = ""            
                msg2 = ""
                ctx.font = "bold italics 100px Times New Roman"
                ctx.fillText("You Lose!", 400, 370)
                drawReplayButton()
                document.getElementById("bgMusic").load()
                document.getElementById("defeat").play()
            } 
            // If neither have won yet, then the bot moves (as long as it is its turn)
            if (p2 == true && gameRunning == true) {
                const myTimeout = setTimeout(botMove,1100)
                const burnTO = setTimeout(checkBurn,2000,2)
            }                   

            clearTimeout(vicTO)
        }   

        function checkBurn(x) {
            // Burns if a 10 is played
            if (stack.at(-1).Value == 10) {
                burn(x)
            }  
            // Burns if there's 4 cards in a row on the stack of the same value
            if (stack.length >= 4) {
                if (stack.at(-4).Value == stack.at(-3).Value && 
                stack.at(-3).Value == stack.at(-2).Value &&
                stack.at(-2).Value == stack.at(-1).Value) {
                    burn(x)
                }
            }
            routine()
            clearTimeout(burnTO)
        }       

        function botMove() {
            if (p2 == true) {
                if (stack.length == 0) {
                    // Selects all cards with the same value as the lowest value card
                    if (handcard2.length > 0) {
                        for (let i = 0; i<handcard2.length; i++) {
                            if (handcard2[i].Value == handcard2[0].Value) {
                                handcard2[i].Selected = true
                                selected.push(handcard2[i])
                            }
                        }
                    } else if (upcard2.length > 0 && handcard2.length == 0) {
                        for (let i = 0; i<upcard2.length; i++) {
                            if (upcard2[i].Value == upcard2[0].Value) {
                                upcard2[i].Selected = true
                                selected.push(upcard2[i])
                            }
                        }
                    } else if (upcard2.length == 0 && handcard2.length == 0) {
                        downcard2[0].Selected = true
                        selected.push(downcard2[0])
                    }
                } else if (stack.length > 0) {
                    // Searches for a valid card to play, forfeits if none found
                    // Plays all copies of the same value card if valid card available
                    if (handcard2.length > 0) {
                        let chosen = handcard2.findIndex((x) => compareCards(x,stack.at(-1)) == true)
                        if (chosen == -1) {
                            return forfeit(2)
                        } else if (chosen != -1) {
                            let chosenVal = handcard2.at(chosen).Value
                            for (let i = 0; i<handcard2.length; i++) {
                                if (handcard2[i].Value == chosenVal) {
                                    handcard2[i].Selected = true
                                    selected.push(handcard2[i])
                                }
                            }
                        }
                    } else if (upcard2.length > 0 && handcard2.length == 0) {
                        let chosen = upcard2.findIndex((x) => compareCards(x,stack.at(-1)) == true)
                        if (chosen == -1) {
                            return forfeit(2)
                        } else if (chosen != -1) {
                            let chosenVal = upcard2.at(chosen).Value
                            for (let i = 0; i<upcard2.length; i++) {
                                if (upcard2[i].Value == chosenVal) {
                                    upcard2[i].Selected = true
                                    selected.push(upcard2[i])
                                }
                            }
                        }
                    } else if (upcard2.length == 0 && handcard2.length == 0) {
                        downcard2[0].Selected = true
                        selected.push(downcard2[0])
                    }
                }
                playCards(2);
                routine();  
                const vicTO = setTimeout(checkVictory, 2000)  
            }    
            clearTimeout(myTimeout)
        }   

        function drawMessage(message,pos,player) {
            // Draws message on the left or right for the player and bot respectively
            let x = pos == "left" ? 75 : 575
            let y = 350;

            ctx.fillStyle = "#FDFD96"
            ctx.roundRect(x, y, 150, 100, 5)                                               
            ctx.fill()

            ctx.strokeStyle = "black"
            ctx.lineWidth = 5
            ctx.lineJoin = "round"
            ctx.strokeRect(x, y, 150, 100)

            ctx.beginPath();
            ctx.moveTo(x+75,350);
            ctx.lineTo(x+75,450);
            ctx.closePath();
            ctx.textAlign = "center"

            ctx.beginPath();
            ctx.moveTo(x,400);
            ctx.lineTo(x+150,400);
            ctx.closePath();
            ctx.textBaseline = "bottom"

            ctx.fillStyle ="black"
            ctx.font = "16px Times New Roman"
            if (player == 1) {
                ctx.fillText("Player 1", x+75, 400)
            } else if (player == 2) {
                ctx.fillText("Player 2", x+75, 400)
            }

            ctx.textBaseline = "top"
            ctx.fillText(message, x+75, 400)  
        }

        function changeTurn() {
            // Swaps over the turns
            if (p1 == true && p2 == false) {
                p1 = false
                p2 = true
            } else if (p1 == false && p2 == true) {
                p1 = true
                p2 = false
            }
        }

        function routine() {
            // Series of functions that are used after each hand is played
            clear();
            if (msg1 != "") {
               drawMessage(msg1,"left",1); 
            }
            if (msg2 != "") {
               drawMessage(msg2,"right",2); 
            }
            draw();
            sortHand(); 
            renderCards();
        }

        function drawInfoButton() {
            // Draws button that leads to info screen
            ctx.beginPath()
            ctx.arc(70,60,24,0,2*Math.PI)
            ctx.strokeStyle = "black"
            ctx.stroke()
            ctx.closePath()

            ctx.beginPath()
            ctx.fillStyle = "black" 
            ctx.textAlign = "center"    
            ctx.textBaseline = "middle"
            ctx.font = "bold 45px Times New Roman"
            ctx.fillText("i",70,65)
            ctx.closePath()
        }   

        function drawInfo() {
            // Shows instructions on how to play the game
            ctx.beginPath()
            ctx.fillStyle = "rgb(0 0 0/85%)"
            ctx.roundRect(50,50,700,700,15)
            ctx.fill()
            ctx.closePath()

            ctx.beginPath()
            ctx.textAlign = "left"
            ctx.textBaseline = "bottom"
            ctx.fillStyle = "white"
            ctx.font = "18px Times New Roman"
            ctx.fillText("The objective of the game is to lose all your cards as quickly as possible.",
                70, 100
            )   
            ctx.fillText("The first to lose all their cards wins.",
                70, 120
            )
            ctx.fillText("Before you press Ready, you have the opportunity to swap upcards with handcards",
                70, 155
            )
            ctx.fillText("to create a stronger set of upcards for later in the game.",
                70, 175
            )   
            ctx.fillText("Each player places a card from their handcards on their turn in the middle (the Stack),",
                70, 210
            )
            ctx.fillText("and replace those cards by drawing from the deck so that they always have at least 3",
                70, 230
            )
            ctx.fillText("handcards. You must play a card with a value equal to or higher than the card in the Stack.",
                70, 250
            )
            ctx.fillText("If a player fails to play a valid card, they add all the cards in the Stack to their hand",
                70, 285
            )
            ctx.fillText("and lose their turn.",
                70, 305
            )
            ctx.fillText("If 4 cards of the same value are next to each other in the Stack, then the Stack is burned.",
                70, 340 
            )
            ctx.fillText("When the Stack is burned, the cards in the Stack are removed from play.",
                70, 360
            )
            ctx.fillText("Whenever the Stack is burned by any means, the player that burned the Stack plays again.",
                70, 395
            )
            ctx.fillText("Once the deck is exhausted, players no longer have to replace handcards that they play.",
                70, 430
            )       
            ctx.fillText("A player can only use their upcards once they've exhausted their handcards, and can only use",
                70, 450
            )
            ctx.fillText("their downcards once they are out of upcards.",
                70, 470 
            )   
            ctx.fillText("2s, 7s, 8s, and 10s are magical cards that can be played regardless of whatever is on top of",
                70, 505
            )
            ctx.fillText("the Stack.",
                70, 525 
            )   
            ctx.fillText("When 7s are played, the next card(s) played must be of a value below 7, or magical.",
                70, 560
            )
            ctx.fillText("8s are considered to be invisible/transparent, and the next card(s) played are compared to the",
                70, 595
            )
            ctx.fillText("card beneath the 8(s).",
                70, 615
            )
            ctx.fillText("10s burn the Stack.",
                70, 650
            )
            ctx.fillText("Jokers are magical, and act like 8s, but additionally they prevent other magical cards from",
                70, 685
            )
            ctx.fillText("being on top of them unless they're also a Joker.",
                70, 705
            )
        
            ctx.textAlign = "right"
            ctx.textBaseline = "middle"
            ctx.font = "bold 40px Verdana"
            ctx.fillText("X", 725, 90)  
            ctx.closePath()
        }   

        function drawSpeaker() {
            // Changes speaker icon depending on whether the music is muted or not
            if (bgm.muted == false) {
                ctx.drawImage(document.getElementById("speakerOn"), 705, 24, 70, 70)
            } else if (bgm.muted == true) {
                ctx.drawImage(document.getElementById("speakerOff"), 705, 24, 70, 70)
            }       
        }       

    </script>
</body>
</html> 